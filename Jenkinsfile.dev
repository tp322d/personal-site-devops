pipeline {
    agent any
    
    environment {
        DEV_SERVER = '192.168.100.6'  
        DEV_USER = 'patste'         
        DEPLOY_DIR = '/opt/personal-site-devops'
    }
    
    stages {
        stage('Checkout Code') {
            steps {
                echo "ðŸ“¥ Checking out latest code..."
                checkout scm
            }
        }
        
        stage('Deploy to Development') {
            steps {
                script {
                    echo "ðŸš€ Starting deployment to DEV server..."
                    
                    // Deploy to development server
                    sh """
                        ssh ${DEV_USER}@${DEV_SERVER} << 'EOF'
                            echo "ðŸ“¥ Getting latest code on server..."
                            cd ${DEPLOY_DIR}
                            
                            echo "ðŸ”„ Pulling latest changes..."
                            git fetch origin
                            git pull origin develop
                            git reset --hard origin/develop
                            
                            echo "ðŸ“‹ Current commit:"
                            git log --oneline -1
                            
                            echo "ðŸ›‘ Stopping existing containers..."
                            docker-compose -f docker-compose.dev.yml down || true
                            
                            echo "ðŸ—ï¸ Building application..."
                            docker-compose -f docker-compose.dev.yml build --no-cache
                            
                            echo "ðŸš€ Starting application..."
                            docker-compose -f docker-compose.dev.yml up -d
                            
                            echo "â³ Waiting for application to start..."
                            sleep 15
                            
                            echo "ðŸ” Running health check..."
                            if curl -f http://localhost:3000/health; then
                                echo "âœ… DEV deployment successful!"
                            else
                                echo "âŒ Health check failed!"
                                docker-compose -f docker-compose.dev.yml logs --tail=10
                                exit 1
                            fi
                            
                            echo "ðŸ§¹ Cleaning up old images..."
                            docker image prune -f || true
EOF
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo "ðŸŽ‰ DEV deployment completed successfully!"
            echo "ðŸŒ Website: http://${DEV_SERVER}:3000"
            echo "â¤ï¸  Health: http://${DEV_SERVER}:3000/health"
        }
        failure {
            echo "âŒ DEV deployment failed!"
        }
        always {
            echo "ðŸ“‹ DEV deployment job finished."
        }
    }
} 