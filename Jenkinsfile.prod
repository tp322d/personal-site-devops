pipeline {
    agent any
    
    environment {
        PROD_SERVER = '46.101.216.36' 
        PROD_USER = 'patste'     
        DEPLOY_DIR = '/opt/personal-site-devops'
    }
    
    stages {
        stage('Checkout Code') {
            steps {
                echo "ðŸ“¥ Checking out latest code..."
                checkout scm
            }
        }
        
        stage('Deploy to Production') {
            steps {
                script {
                    echo "ðŸš€ Starting deployment to PRODUCTION server..."
                    
                    // Deploy to production server
                    sh """
                        ssh ${PROD_USER}@${PROD_SERVER} << 'EOF'
                            echo "ðŸ“¥ Getting latest code on server..."
                            cd ${DEPLOY_DIR}
                            
                            echo "ðŸ”„ Pulling latest changes..."
                            git fetch origin
                            git pull origin main
                            git reset --hard origin/main
                            
                            echo "ðŸ“‹ Current commit:"
                            git log --oneline -1
                            
                            echo "ðŸ›‘ Stopping existing containers..."
                            docker-compose -f docker-compose.prod.yml down || true
                            
                            echo "ðŸ—ï¸ Building application..."
                            docker-compose -f docker-compose.prod.yml build --no-cache
                            
                            echo "ðŸš€ Starting application..."
                            docker-compose -f docker-compose.prod.yml up -d
                            
                            echo "â³ Waiting for application to start..."
                            sleep 20
                            
                            echo "ðŸ” Running health check..."
                            if curl -f http://localhost:3000/health; then
                                echo "âœ… PRODUCTION deployment successful!"
                            else
                                echo "âŒ Health check failed!"
                                docker-compose -f docker-compose.prod.yml logs --tail=10
                                exit 1
                            fi
                            
                            echo "ðŸ§¹ Cleaning up old images..."
                            docker image prune -f || true
EOF
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo "ðŸŽ‰ PRODUCTION deployment completed successfully!"
            echo "ðŸŒ Website: http://${PROD_SERVER}:3000"
            echo "â¤ï¸  Health: http://${PROD_SERVER}:3000/health"
            echo "ðŸ”— Configure your reverse proxy to point to port 3000"
        }
        failure {
            echo "âŒ PRODUCTION deployment failed!"
        }
        always {
            echo "ðŸ“‹ PRODUCTION deployment job finished."
        }
    }
} 